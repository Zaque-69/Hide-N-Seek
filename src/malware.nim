import 
    os, 
    strformat

from shell import 
    echoWarning,
    runShellCommand

from helpers import 
    fileList,
    stringToSequence

from nimrules/trojan/dropper/dropper import 
    scanFilesDropperTrojan

from nimrules/trojan/flooder/flooder import 
    scanFilesFlooderTrojan

# Recursive procedure to find all the malitious files in the path 
proc runYaraRules( path: string, finalRules : seq[string] ) : void =  
    for file in walkDir(path) : 
        if file.kind == pcFile : 
            for rule in finalRules : 
                runShellCommand(fmt"yara {rule} {file.path} > File/positiverule.txt")

                #Transforming the output in a sequence from the file
                let fileContent : string = readFile("File/positiverule.txt")
                let seqContent : seq[string] = stringToSequence(fileContent)

                if seqContent.len > 0 : 
                    echoWarning(file.path, seqContent[0] & seqContent[1] & '\n')

        else : runYaraRules(file.path, finalRules)

# The main procedure
proc main() =
    var
        argument : string = paramStr(1) 
        folders : seq[string] = fileList("yararules/") 
        rules : seq[string] = @[]

    # Extracting the rules from your specific OS
    for folder in folders : 
        rules &= fileList(folder)

    # Scanning the files with Yara rules
    runYaraRules(argument, rules)

    # Scanning the files with Nim code 
    scanFilesDropperTrojan(argument)
    scanFilesFlooderTrojan(argument)

when isMainModule : 
    main()