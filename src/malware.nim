import os, strformat, strutils, sequtils
import std/[terminal]

from common import filelist, runShellCommand

proc echoWarning ( file, positiverule : string ) : void = 
    #Echo the warning output of a PUA file
    stdout.styledWriteLine(fgRed, styleBright, fmt"[WARNING!] {file} may contain malitious bytes : {positiverule}" )

when defined windows: 
    var sys = "windows"
else :
    var sys  = "linux"
var
    argument : string = paramStr(1)                         #The argument
    #Here are the rules from each OS + the common rules     
    ruleFolders : seq[string] = filelist(fmt"rules/{sys}")  #List of the folders with the rules, specific OS

proc runYaraRules( location: string ) : void =  
    #Run each rule with each file in the pach
    var rules : seq[string] = filelist(fmt"rules/common")
    for folder in ruleFolders : 
        rules &= filelist(folder)
        
    for rule in rules : 
        #Run each YARA rule from the OS chosen with the files from argument
        runShellCommand(fmt"yara {rule} {location} > files/positiverule.txt")
        let filecontent = readFile("files/positiverule.txt")
        let content : seq[string] = filecontent.split().filterIt(it != "")
        
        if content.len > 0 : 
            #[ The output of the file is written in { files/positiverule.txt }, so 
               if there is an output, it will be written an info message ]#
            echoWarning(location, filecontent)

proc main() =
    runYaraRules(argument)

main()