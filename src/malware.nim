from runCommand import runShellCommand, echoStatusFile
import os, strformat, strutils, sequtils

#return the files from a path
proc return_file_list ( path : string ) : seq[string] =
    var list : seq[string] = @[] 
    for file in walkDir(path) : 
        add(list, file.path) 

    return list

var
    arg_1 : string = paramStr(1)
    files_path_list : seq[string] = return_file_list(arg_1)  
    yara_rules_list : seq[string] = return_file_list("rules")

#if 'files_path_list' have 0 elements then is a file
proc main() =
    if files_path_list.len() > 0 : 
        for file in files_path_list : 
            for rule in yara_rules_list : 
                runShellCommand(fmt"yara {rule} {file} > File/positive_rule.txt")
                let pr_content : seq[string] = readFile("File/positive_rule.txt").split().filterIt(it != "")
                if len(pr_content) > 0 : 
                    echoStatusFile(file, readFile("File/positive_rule.txt"), true)
    else: 
        for rule in yara_rules_list : 
            runShellCommand(fmt"yara {rule} {arg_1} > File/positive_rule.txt")
            let pr_content : seq[string] = readFile("File/positive_rule.txt").split().filterIt(it != "")
            if len(pr_content) > 0 : 
                echoStatusFile(arg_1, readFile("File/positive_rule.txt"), true)

main()