import 
    os

from ./common/strings import 
    suspiciousMoneroComments,
    suspiciousMinerComments,
    suspiciousCryptoComments,
    virusRaportMiner

from ../common/header import 
    checkHeaderELF

from ../common/file import 
    fileSize,
    deleteFile,
    checkEachSuspiciousLine

from ../common/helpers import 
    appendToFile

proc checkFileMoneroMiner (filename : string) : void = 
    try : 
        var count : int = 0
        let 
            suspicious_monero_comments : seq[string] = checkEachSuspiciousLine(filename, suspiciousMoneroComments())
            suspicious_miner_comments : seq[string] = checkEachSuspiciousLine(filename, suspiciousMinerComments())
            suspicious_crypto_comments : seq[string] = checkEachSuspiciousLine(filename, suspiciousCryptoComments())

        # The file size should be between 2.5MB and 20MB
        if fileSize(1000000, 20000000, filename) : 
            count += 1

        # Checking for if the file have a Linux executable header
        if checkHeaderELF(filename) : 
            count += 1

        for sequence in @[
            suspicious_monero_comments, 
            suspicious_miner_comments, 
            suspicious_crypto_comments
            ] :
                
            if len(sequence) > 1 : 
                count += 1

        if count >= 3 :

            let 
                virus_raport : string = virusRaportMiner(
                    filename,
                    "Monero Miner", 
                    os.getFileSize(filename),
                    suspicious_monero_comments, 
                    suspicious_miner_comments, 
                    suspicious_crypto_comments
                    )
                raport : string = "../raport_sheet_crypto" 

            appendToFile(raport, virus_raport)

    except OSError : 
        discard

# Recursive function to scan the files from a path
proc scanFilesMiner * (path : string) : void = 

    for file in walkDir(path, false, true) : 
        if file.kind == pcFile : 
            checkFileMoneroMiner(file.path) 
           
        else : 
            scanFilesMiner(file.path)
        